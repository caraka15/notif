<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= pageTitle %>
  </title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f0f2f5;
      color: #1c1e21;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      background-color: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-width: 950px;
      width: 100%;
      margin: 20px auto;
      box-sizing: border-box;
    }

    h1,
    h2,
    h3 {
      color: #1877f2;
      /* Biru Facebook */
      margin-top: 0;
      margin-bottom: 0.75em;
    }

    h1 {
      border-bottom: 2px solid #1877f2;
      padding-bottom: 10px;
      text-align: center;
      font-size: 2em;
      /* Sedikit lebih besar */
      color: #1c1e21;
      /* Hitam untuk kontras */
    }

    h2 {
      margin-top: 30px;
      border-bottom: 1px solid #ccd0d5;
      /* Abu-abu Facebook */
      padding-bottom: 8px;
      font-size: 1.6em;
    }

    h3 {
      margin-top: 20px;
      font-size: 1.3em;
      color: #333;
    }

    .info-box,
    .epoch-progress-box,
    .phrase-details-box,
    .epoch-list-box,
    .history-box {
      background-color: #f7f8fa;
      /* Sedikit lebih terang dari body */
      border: 1px solid #dddfe2;
      /* Border abu-abu Facebook */
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 25px;
    }

    .epoch-list {
      list-style-type: none;
      padding: 0;
    }

    .epoch-item {
      background-color: #fff;
      border: 1px solid #e0e0e0;
      margin-bottom: 10px;
      padding: 12px 18px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      transition: box-shadow 0.2s ease-in-out;
    }

    .epoch-item:hover {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    }

    .epoch-info {
      flex-grow: 1;
      min-width: 220px;
    }

    .epoch-number {
      font-weight: 600;
      /* Sedikit lebih tebal */
      color: #1877f2;
      font-size: 1.1em;
    }

    .status {
      padding: 7px 14px;
      border-radius: 16px;
      color: white;
      font-weight: bold;
      text-align: center;
      font-size: 0.9em;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
      min-width: 100px;
      /* Lebar minimum untuk status */
    }

    .status-pass {
      background-color: #42b72a;
      /* Hijau Facebook */
    }

    .status-fail {
      background-color: #fa3e3e;
      /* Merah Facebook */
    }

    .status-skip {
      background-color: #606770;
      /* Abu-abu gelap Facebook */
    }

    .status-berjalan {
      background-color: #1877f2;
      /* Biru Facebook */
    }

    .status-error {
      background-color: #ffba00;
      color: #333;
    }

    .status-not-ready {
      background-color: #bec3c9;
    }

    .status-other {
      background-color: #8a9ba8;
    }

    /* Untuk status 'OTHER' */
    .status-unknown {
      background-color: #ced0d4;
      color: #333;
    }

    /* Untuk status 'UNKNOWN' */


    .error-message {
      color: #721c24;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 12px;
      border-radius: 5px;
      margin-top: 10px;
      margin-bottom: 15px;
      font-size: 0.95em;
    }

    .details {
      font-size: 0.9em;
      color: #606770;
      margin-top: 6px;
    }

    .details span {
      display: block;
      margin-bottom: 4px;
    }

    .details strong {
      color: #1c1e21;
    }

    .running-duration {
      font-style: italic;
      color: #1877f2;
      display: block;
      font-size: 0.85em;
      margin-top: 4px;
    }

    .phrase-times span {
      display: block;
      margin-bottom: 5px;
      font-size: 0.95em;
    }

    .progress-bar-container {
      width: 100%;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-top: 10px;
      height: 24px;
      overflow: hidden;
      border: 1px solid #ced4da;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: #1877f2;
      border-radius: 4px;
      /* Disesuaikan agar pas */
      text-align: center;
      line-height: 24px;
      color: white;
      font-size: 0.9em;
      font-weight: bold;
      transition: width 0.6s ease-in-out;
    }

    .live-data-section p {
      margin: 10px 0;
      font-size: 1em;
    }

    code {
      word-break: break-all;
      font-size: 0.95em;
      background-color: #f0f2f5;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #dddfe2;
    }

    .history-item {
      background-color: #fff;
      border: 1px solid #e0e6ed;
      margin-bottom: 12px;
      padding: 12px 18px;
      border-radius: 6px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
    }

    .history-item h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #1877f2;
      font-size: 1.2em;
    }

    .history-item p {
      margin: 6px 0;
      font-size: 1em;
    }

    .history-item p strong {
      color: #1c1e21;
    }

    /* BARU: Style untuk collapsible history */
    .history-toggle {
      background-color: #e4e6eb;
      /* Warna abu-abu netral */
      color: #1c1e21;
      /* Warna teks utama */
      padding: 12px 15px;
      border: 1px solid #dddfe2;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      text-align: left;
      font-size: 1.4em;
      /* Sesuaikan dengan ukuran H2 */
      font-weight: bold;
      margin-bottom: 0;
      /* Hapus margin bawah jika konten tersembunyi */
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s ease;
    }

    .history-toggle:hover {
      background-color: #d8dbdf;
      /* Sedikit lebih gelap saat hover */
    }

    .history-toggle .arrow {
      transition: transform 0.2s ease-in-out;
      display: inline-block;
      font-size: 0.8em;
      /* Ukuran panah lebih kecil */
    }

    .history-content {
      display: none;
      /* Awalnya tersembunyi */
      padding: 15px;
      border: 1px solid #dddfe2;
      border-top: none;
      /* Hapus border atas karena sudah ada di tombol */
      border-radius: 0 0 5px 5px;
      /* Sudut rounded hanya di bawah */
      margin-top: 0;
    }

    .history-box.open .history-content {
      /* Kelas 'open' akan ditambahkan ke history-box */
      display: block;
    }

    .history-box.open .history-toggle .arrow {
      transform: rotate(90deg);
      /* Panah ke bawah saat terbuka */
    }

    /* Akhir style untuk collapsible history */

    /* Media Query untuk layar yang lebih kecil */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 15px auto;
      }

      h1 {
        font-size: 1.7em;
      }

      h2,
      .history-toggle {
        /* Sesuaikan history-toggle juga */
        font-size: 1.4em;
        margin-top: 25px;
      }

      .history-toggle {
        margin-bottom: 0;
      }


      h3 {
        font-size: 1.2em;
        margin-top: 15px;
      }

      .epoch-item {
        padding: 10px 12px;
      }

      .live-data-section p {
        font-size: 0.95em;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 5px;
      }

      .container {
        padding: 10px;
        margin: 10px auto;
      }

      h1 {
        font-size: 1.5em;
      }

      h2,
      .history-toggle {
        /* Sesuaikan history-toggle juga */
        font-size: 1.3em;
        margin-top: 20px;
      }

      .history-toggle {
        margin-bottom: 0;
      }


      h3 {
        font-size: 1.1em;
        margin-top: 10px;
      }

      .epoch-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .epoch-info {
        width: 100%;
        min-width: 0;
        margin-bottom: 0;
      }

      .status {
        width: 100%;
        margin-left: 0;
        margin-top: 5px;
        box-sizing: border-box;
      }

      .live-data-section p {
        font-size: 0.9em;
      }

      .history-item {
        padding: 10px 15px;
      }

      .history-item h4 {
        font-size: 1.1em;
      }

      .history-item p {
        font-size: 0.95em;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Status Validator Humanode</h1>
    <div class="info-box">
      <p><strong>Alamat Validator:</strong> <code><%= validatorAddress %></code></p>
      <% if (errorMessage && (!latestPhraseNumber || latestPhraseNumber < 1) && (!phraseHistory ||
               phraseHistory.length===0)) { %>
      <p class="error-message">
        <%= errorMessage %>
      </p>
      <% } %>
    </div>

    <%# Progress Epoch Jaringan Saat Ini %>
    <div class="epoch-progress-box live-data-section">
      <h3>
        Progress Epoch Jaringan Saat Ini
        <% if (webServerEpochProgress && webServerEpochProgress.currentEpochSystem !==null && typeof
                 webServerEpochProgress.currentEpochSystem !=='undefined' ) { %>
        (Epoch <%= webServerEpochProgress.currentEpochSystem %>)
        <% } %>
      </h3>

      <% if (webServerEpochProgress && webServerEpochProgress.error && webServerEpochProgress.error !=='N/A'
               && webServerEpochProgress.error !==null) { %>
      <p class="error-message">
        Error data epoch live: <%= webServerEpochProgress.error %>
      </p>
      <% } %>

      <% if (webServerEpochProgress && (!webServerEpochProgress.error ||
                     webServerEpochProgress.error==='N/A' || webServerEpochProgress.error===null)) { %>
      <p>
        <strong>Blok dalam Epoch:</strong>
        <%= typeof webServerEpochProgress.currentBlockInEpoch !=='undefined' ?
                                 webServerEpochProgress.currentBlockInEpoch.toLocaleString('id-ID') : 'N/A' %> /
        <%= typeof webServerEpochProgress.blocksInEpoch !=='undefined' &&
                                 webServerEpochProgress.blocksInEpoch> 0 ?
                                 webServerEpochProgress.blocksInEpoch.toLocaleString('id-ID') : (typeof
                                 webServerEpochProgress.blocksInEpoch !== 'undefined' ? '0' : 'N/A') %>
      </p>
      <% if (typeof webServerEpochProgress.blocksInEpoch !=='undefined' &&
                       webServerEpochProgress.blocksInEpoch> 0 && typeof
                       webServerEpochProgress.percentageCompleted !== 'undefined') { %>
      <div class="progress-bar-container">
        <div class="progress-bar" style="width: <%= webServerEpochProgress.percentageCompleted.toFixed(2) %>%;">
          <%= webServerEpochProgress.percentageCompleted.toFixed(1) %>%
        </div>
      </div>
      <% } %>
      <p>
        <strong>Sisa Blok:</strong>
        <%= typeof webServerEpochProgress.remainingBlocksInEpoch !=='undefined' ?
                                 webServerEpochProgress.remainingBlocksInEpoch.toLocaleString('id-ID')
                                 : 'N/A' %>
      </p>
      <p>
        <strong>Persentase Selesai:</strong>
        <%= typeof webServerEpochProgress.percentageCompleted !=='undefined' ?
                                 webServerEpochProgress.percentageCompleted.toFixed(2) : 'N/A' %>%
      </p>
      <p>
        <strong>Perkiraan Epoch Berikutnya dalam:</strong>
        <%= webServerEpochProgress.nextEpochETA || 'N/A' %>
      </p>
      <p>
        <strong>Estimasi Waktu Selesai Epoch Ini:</strong>
        <%= webServerEpochProgress.currentEpochEstimatedCompletion || 'N/A' %>
        <% if (webServerEpochProgress.currentEpochEstimatedCompletion &&
                         webServerEpochProgress.currentEpochEstimatedCompletion !=='N/A' ) { %>
        (WIB)
        <% } %>
      </p>
      <% if (webServerEpochProgress && webServerEpochProgress.currentAbsoluteBlock &&
                       webServerEpochProgress.currentAbsoluteBlock> 0) { %>
      <p style="font-size:0.9em; color: #555;">(Blok Jaringan Saat Ini: <%=
                                 webServerEpochProgress.currentAbsoluteBlock.toLocaleString('id-ID') %>)
      </p>
      <% } %>
      <% } else if (webServerEpochProgress && !webServerEpochProgress.error) { %>
      <p>Memuat data epoch jaringan atau data tidak lengkap...</p>
      <% } else if (!webServerEpochProgress) { %>
      <p>Data progres epoch tidak dapat dimuat.</p>
      <% } %>
    </div>

    <%# BARU: Bagian Riwayat Cycle (Collapsible) - DIPINDAHKAN KE SINI %>
    <div class="history-box">
      <button type="button" class="history-toggle" aria-expanded="false" aria-controls="historyContentSection">
        Riwayat Partisipasi Cycle Validator <span class="arrow">&#9654;</span>
      </button>
      <div class="history-content" id="historyContentSection">
        <% if (phraseHistory && phraseHistory.length > 0) { %>
        <% let displayedHistoryCount = 0; %>
        <% phraseHistory.forEach(item => { %>
        <% if (item.phraseNumber !== latestPhraseNumber || (item.phraseNumber === latestPhraseNumber && !phraseData)) { %>
        <% if (item.hasSpecificData) { %>
        <div class="history-item">
          <h4>
            Cycle <%= item.phraseNumber %>
            <% if (item.startEpoch && item.endEpoch) { %>
            (Epoch <%= item.startEpoch %> - <%= item.endEpoch %>)
            <% } %>
          </h4>
          <p><strong>Pass:</strong> <%= item.passCount %></p>
          <p><strong>Skip:</strong> <%= item.skipCount %> (anggap saja pass, skip karena kelalaian bot)</p>
          <p><strong>Fail:</strong> <%= item.failCount %></p>
          <% if (item.otherCount > 0) { %>
          <p><em>Status Lain/Belum Selesai: <%= item.otherCount %></em></p>
          <% } %>
        </div>
        <% displayedHistoryCount++; %>
        <% } %>
        <% } %>
        <% }); %>
        <% if (displayedHistoryCount === 0) { %>
        <p>Tidak ada riwayat cycle partisipasi spesifik validator untuk ditampilkan.</p>
        <% } %>
        <% } else { %>
        <p>Tidak ada data riwayat cycle yang ditemukan.</p>
        <% } %>
      </div>
    </div>


    <%# Informasi cycle TERBARU %>
    <% if (latestPhraseNumber && latestPhraseNumber> 0) { %>
    <div class="phrase-details-box">
      <h2>Cycle Terbaru Dipantau: <%= latestPhraseNumber %>
        <% if (latestPhraseStartEpoch && latestPhraseEndEpoch) { %>
        (Epoch <%= latestPhraseStartEpoch %> - <%= latestPhraseEndEpoch %>)
        <% } else if (latestPhraseStartEpoch) { %>
        (Epoch <%= latestPhraseStartEpoch %> - N/A)
        <% } else { %>
        (Rentang Epoch N/A)
        <% } %>
      </h2>
      <div class="phrase-times">
        <% if (actualPhraseStartTimeForDisplay) { %>
        <span><strong>Waktu Mulai Aktual Cycle:</strong>
          <%= new Date(actualPhraseStartTimeForDisplay).toLocaleString('id-ID', {
                                 dateStyle: 'full' , timeStyle: 'long' , timeZone: 'Asia/Jakarta' }) %>
        </span>
        <% } else { %>
        <span><strong>Waktu Mulai Aktual Cycle:</strong> Belum tercatat / Gagal
          diambil</span>
        <% } %>

        <% if (estimatedPhraseEndTime) { %>
        <span><strong>Estimasi Akhir Cycle:</strong>
          <%= new Date(estimatedPhraseEndTime).toLocaleString('id-ID', {
                                   dateStyle: 'full' , timeStyle: 'long' , timeZone: 'Asia/Jakarta' })
                                   %>
        </span>
        <% } else if (actualPhraseStartTimeForDisplay) { %>
        <span><strong>Estimasi Akhir Cycle:</strong> Gagal dihitung.</span>
        <% } else { %>
        <span><strong>Estimasi Akhir Cycle:</strong> Belum dapat
          dihitung.</span>
        <% } %>
      </div>

      <% if (errorMessage && latestPhraseNumber && latestPhraseNumber> 0 && (!phraseData) &&
                       errorMessage.includes(validatorAddress)) { %>
      <p class="error-message" style="margin-top: 10px;">
        <%= errorMessage %>
      </p>
      <% } else if (errorMessage && latestPhraseNumber && latestPhraseNumber> 0 &&
                               errorMessage.includes("frasa " + latestPhraseNumber) &&
                               !errorMessage.includes(validatorAddress)) { %>
      <%# Error umum terkait Cycle terbaru, bukan spesifik validator %>
      <p class="error-message" style="margin-top: 10px;">
        <%= errorMessage %>
      </p>
      <% } %>
    </div>

    <%# Detail Epoch per Cycle TERBARU %>
    <% if (allEpochsInLatestPhrase && allEpochsInLatestPhrase.length> 0 && phraseData &&
               phraseData.epochs) { %>
    <div class="epoch-list-box">
      <h3>Detail Partisipasi Epoch untuk Cycle <%= latestPhraseNumber %>
      </h3>
      <ul class="epoch-list">
        <% const serverRenderTime=Date.now(); %>
        <% const currentLiveEpochForComparison=webServerEpochProgress ?
                               webServerEpochProgress.currentEpochSystem : null; %>
        <% const calculatePhraseNumberOfEpochLocal=(epochNum)=> {
                               if (!epochNum || epochNum < FIRST_EVER_PHRASE_START_EPOCH) return 0;
                                   const epochsSinceFirst=epochNum - FIRST_EVER_PHRASE_START_EPOCH;
                                   return Math.floor(epochsSinceFirst / PHRASE_DURATION_EPOCHS) + 1; };
                                   %>
        <% allEpochsInLatestPhrase.sort((a, b)=> a - b).forEach(epochNum =>
                               { %>
        <% const epoch=phraseData.epochs[epochNum.toString()]; %>
        <% let statusClass='status-not-ready' ; %>
        <% let statusText='BELUM ADA DATA' ; %>
        <% let inactiveMinutes='N/A' ; %>
        <% let epochStartTimeDisplay='N/A' ; %>
        <% let runningDurationDisplay='' ; %>
        <% let rewardsDisplay='' ; %>
        <% let reasonDisplay='' ; %>

        <% if (epoch) { %>
        <% statusText=epoch.status
                                   || 'TIDAK DIKETAHUI' ;
                                   %>
        <% switch
                                   (statusText.toUpperCase())
                                   {
                                   case 'PASS_API_HELPER'
                                   :
                                   case 'PARTICIPATED'
                                   : case 'PASS' :
                                   statusClass='status-pass'
                                   ; statusText='PASS'
                                   ; break;
                                   case 'FAIL_API_HELPER'
                                   : case 'MISSED' :
                                   case 'FAIL' :
                                   statusClass='status-fail'
                                   ; statusText='FAIL'
                                   ; break;
                                   case 'SKIP_HISTORIS'
                                   : case 'SKIP' :
                                   statusClass='status-skip'
                                   ; statusText='SKIP'
                                   ; break;
                                   case 'BERJALAN' :
                                   case 'PENDING' :
                                   case 'RUNNING' :
                                   statusClass='status-berjalan'
                                   ;
                                   statusText='BERJALAN'
                                   ; if
                                   (epoch.epochStartTime)
                                   { const
                                   startTime=new
                                   Date(epoch.epochStartTime).getTime();
                                   if
                                   (!isNaN(startTime)
                                   && startTime <
                                   serverRenderTime) {
                                   const
                                   durationMs=serverRenderTime
                                   - startTime; const
                                   hours=Math.floor(durationMs
                                   / (1000 * 60 * 60));
                                   const
                                   minutes=Math.floor((durationMs
                                   % (1000 * 60 * 60))
                                   / (1000 * 60));
                                   runningDurationDisplay=`(Sudah
                                   berjalan: ${hours}
                                   jam ${minutes}
                                   menit)`; } else if
                                   (isNaN(startTime)) {
                                   runningDurationDisplay=`(Waktu
                                   mulai epoch tidak
                                   valid)`; } else {
                                   runningDurationDisplay=`(Akan
                                   datang/baru mulai)`;
                                   } } else if
                                   (currentLiveEpochForComparison
                                   &&
                                   epochNum==currentLiveEpochForComparison)
                                   {
                                   runningDurationDisplay=`(Waktu
                                   mulai epoch belum
                                   tercatat di JSON)`;
                                   } break; default:
                                   statusClass='status-error'
                                   ;
                                   statusText=epoch.status; // Tampilkan status asli jika tidak dikenali
                                   }%>
        <% if
                                   (epoch.totalApiHelperInactiveSeconds
                                   !==undefined) {
                                   inactiveMinutes=Math.round(epoch.totalApiHelperInactiveSeconds
                                   / 60); } %>
        <% if
                                   (epoch.epochStartTime)
                                   {
                                   epochStartTimeDisplay=new
                                   Date(epoch.epochStartTime).toLocaleString('id-ID',
                                   {
                                   day: '2-digit'
                                   ,
                                   month: 'short'
                                   ,
                                   year: 'numeric'
                                   ,
                                   hour: '2-digit'
                                   ,
                                   minute: '2-digit'
                                   ,
                                   timeZone: 'Asia/Jakarta'
                                   }); } %>
        <% if
                                   (epoch.rewards
                                   &&
                                   parseFloat(epoch.rewards)>
                                   0) {
                                   rewardsDisplay
                                   =
                                   `Rewards:
                                   ${parseFloat(epoch.rewards).toFixed(4)}`;
                                   } %>
        <% if
                                   (epoch.reason)
                                   {
                                   reasonDisplay=`Alasan:
                                   ${epoch.reason}`;
                                   } %>
        <% } else
                                   if
                                   (currentLiveEpochForComparison
                                   !==null
                                   &&
                                   epochNum>
                                   currentLiveEpochForComparison
                                   &&
                                   latestPhraseNumber
                                   ==
                                   calculatePhraseNumberOfEpochLocal(currentLiveEpochForComparison))
                                   {
                                   %>
        <% statusText='AKAN DATANG'
                                   ;
                                   statusClass='status-not-ready'
                                   ;
                                   %>
        <% } else
                                   if
                                   (currentLiveEpochForComparison
                                   !==null
                                   &&
                                   epochNum
                                   <
                                   currentLiveEpochForComparison)
                                   {
                                   %>
        <% statusText='TIDAK ADA DATA (ASUMSI MISSED)'
                                   ;
                                   statusClass='status-fail'
                                   ;
                                   %>
        <% } else
                                   if
                                   (currentLiveEpochForComparison
                                   !==null
                                   &&
                                   epochNum==currentLiveEpochForComparison)
                                   {
                                   %>
        <% statusText='SEDANG BERJALAN (CEK LIVE)'
                                   ;
                                   statusClass='status-berjalan'
                                   ;
                                   %>
        <% }
                                   %>
        <li class="epoch-item">
          <div class="epoch-info">
            <span class="epoch-number">Epoch
              <%= epochNum
                                   %>
            </span>
            <% if
                                   (runningDurationDisplay)
                                   {
                                   %>
            <span class="running-duration">
              <%= runningDurationDisplay
                                   %>
            </span>
            <% }
                                   %>
            <div class="details">
              <span><strong>Mulai
                  Epoch:</strong>
                <%= epochStartTimeDisplay
                                   %>
              </span>
              <span><strong>Total
                  Tidak
                  Aktif:</strong>
                <%= inactiveMinutes
                                   %>
                menit
              </span>
              <% if
                                   (rewardsDisplay)
                                   { %>
              <span><strong>
                  <%= rewardsDisplay
                                   %>
                </strong></span>
              <% }
                                   %>
              <% if
                                   (reasonDisplay)
                                   { %>
              <span><strong>
                  <%= reasonDisplay
                                   %>
                </strong></span>
              <% }
                                   %>
            </div>
          </div>
          <span class="status <%= statusClass %>">
            <%= statusText
                                   %>
          </span>
        </li>
        <% });
                                   %>
      </ul>
    </div>
    <% } else if (latestPhraseNumber && latestPhraseNumber> 0 && (!phraseData) && errorMessage
                       && errorMessage.includes(validatorAddress)) { %>
    <%# Error message already shown in phrase-details-box if !phraseData for latest phrase %>
    <% } else if (latestPhraseNumber && latestPhraseNumber> 0 && (!phraseData ||
                               !phraseData.epochs)) { %>

    <div class="epoch-list-box">
      <h3>Detail Partisipasi Epoch untuk Cycle <%= latestPhraseNumber %>
      </h3>
      <p>Tidak ada data detail epoch yang ditemukan untuk validator ini pada
        Cycle <%= latestPhraseNumber %>.</p>
    </div>
    <% } %>

    <% } else if (!errorMessage) { %>
    <%# This case means no latestPhraseNumber was found AND no general errorMessage was set %>
    <div class="phrase-details-box">
      <h2>Informasi Cycle</h2>
      <p>Tidak ada data Cycle terbaru yang dapat ditampilkan.</p>
    </div>
    <% } %>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const historyBox = document.querySelector('.history-box');
      const historyToggle = document.querySelector('.history-toggle');

      if (historyBox && historyToggle) {
        const content = document.getElementById('historyContentSection'); // Use ID for robustness
        const arrow = historyToggle.querySelector('.arrow');

        // Inisialisasi: Konten tersembunyi, panah ke kanan
        // (CSS already hides .history-content, so no need to set display:none here via JS)
        // Class 'open' on historyBox controls visibility via CSS
        let isOpen = historyBox.classList.contains('open'); // Check if initially open from class
        historyToggle.setAttribute('aria-expanded', isOpen.toString());

        if (arrow) { // Set initial arrow state based on 'open' class
          arrow.style.transform = isOpen ? 'rotate(90deg)' : 'rotate(0deg)';
        }


        historyToggle.addEventListener('click', function() {
          isOpen = historyBox.classList.toggle('open'); // Toggle 'open' class on the parent
          historyToggle.setAttribute('aria-expanded', isOpen.toString());

          if (arrow) {
            arrow.style.transform = isOpen ? 'rotate(90deg)' : 'rotate(0deg)';
          }
        });
      }
    });
  </script>
</body>

</html>